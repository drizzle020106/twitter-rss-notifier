name: Robust RSS Notifier
on:
  schedule:
    - cron: "*/30 * * * *"  # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  rss-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Push Notification
        run: |
          #######################################
          # é…ç½®åŒºï¼ˆç›´æ¥ä¿®æ”¹ä»¥ä¸‹å‚æ•°å³å¯ï¼‰       #
          #######################################
          
          # WxPusher é…ç½®ï¼ˆå¿…å¡«ï¼‰
          WXPUSHER_TOKEN="AT_8dVtF3Ao4hEvmxZ65RZoaD39tfD5arNa"  # æ›¿æ¢ä¸ºä½ çš„AppToken
          WXPUSHER_UID="UID_fGIbty1MomMiPuxSmqwdugIFDggm"       # æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·UID
          
          # RSS æºé…ç½®ï¼ˆæ”¯æŒä»»ä½•æ ‡å‡†RSSï¼‰
          RSS_URL="https://rsshub.app/twitter/user/elonmusk"  # æ›¿æ¢ä¸ºç›®æ ‡æº
          
          # é€šçŸ¥å†…å®¹æ¨¡æ¿
          MESSAGE_TEMPLATE="ğŸ“…ã€æ›´æ–°é€šçŸ¥ã€‘\n\næ ‡é¢˜ï¼š{title}\n\né“¾æ¥ï¼š{link}"

          #######################################
          # æ ¸å¿ƒé€»è¾‘ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰                #
          #######################################
          
          # å‡½æ•°ï¼šå®‰å…¨è·å–XMLèŠ‚ç‚¹å€¼
          # å‚æ•°: $1=XMLå†…å®¹, $2=XPathè¡¨è¾¾å¼
          get_xml_value() {
            echo "$1" | xmlstarlet sel -t -v "$2" 2>/dev/null || echo ""
          }

          # å‡½æ•°ï¼šå‘é€é€šçŸ¥åˆ°å¾®ä¿¡
          send_notification() {
            local title="$1"
            local link="$2"
            
            # å†…å®¹æ¶ˆæ¯’ï¼ˆç§»é™¤éæ³•å­—ç¬¦ï¼‰
            local clean_title=$(echo "$title" | tr -d '\n\r"' | head -c 200)
            local clean_link=$(echo "$link" | grep -E '^https?://' || echo "https://github.com")
            
            # ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆå†…å®¹
            local content=$(echo "$MESSAGE_TEMPLATE" | 
              sed "s/{title}/$clean_title/g" |
              sed "s/{link}/$clean_link/g")
            
            # æ„å»ºJSONè¯·æ±‚ä½“ï¼ˆä½¿ç”¨jqç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
            local json_payload=$(jq -n \
              --arg token "$WXPUSHER_TOKEN" \
              --arg uid "$WXPUSHER_UID" \
              --arg content "$content" \
              '{
                appToken: $token,
                content: $content,
                uid: $uid
              }')
            
            # å‘é€è¯·æ±‚ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
              -H "Content-Type: application/json" \
              -d "$json_payload" \
              --retry 2 \
              --max-time 30
          }

          #######################################
          # ä¸»æ‰§è¡Œæµç¨‹                          #
          #######################################
          
          echo "=== å¼€å§‹è·å–RSSæ•°æ® ==="
          
          # è·å–RSSå†…å®¹ï¼ˆå¸¦å¤±è´¥é‡è¯•ï¼‰
          RSS_CONTENT=$(curl -fsL --retry 3 "$RSS_URL" || echo "
            <rss>
              <channel>
                <item>
                  <title>[RSSæœåŠ¡ä¸å¯ç”¨] æœ€åæ£€æµ‹äº $(date +'%Y-%m-%d %H:%M')</title>
                  <link>https://status.github.com</link>
                </item>
              </channel>
            </rss>")
          
          # è§£æå…³é”®æ•°æ®
          ITEM_TITLE=$(get_xml_value "$RSS_CONTENT" "//item[1]/title")
          ITEM_LINK=$(get_xml_value "$RSS_CONTENT" "//item[1]/link")
          
          echo "è§£æç»“æœï¼š"
          echo "æ ‡é¢˜: $ITEM_TITLE"
          echo "é“¾æ¥: $ITEM_LINK"
          
          # å‘é€é€šçŸ¥
          echo "=== å¼€å§‹æ¨é€é€šçŸ¥ ==="
          send_notification "$ITEM_TITLE" "$ITEM_LINK"
          
          echo "=== ä»»åŠ¡å®Œæˆ ==="
